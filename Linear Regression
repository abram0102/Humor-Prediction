import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.linear_model import LinearRegression
from sklearn.pipeline import make_pipeline
from sklearn.metrics import mean_absolute_error, mean_squared_error
from sklearn.model_selection import train_test_split
import numpy as np
import matplotlib.pyplot as plt
import joblib

# Path configuration
TRAIN_PATH = "data/task-1/train.csv"

# Column names in the dataset
# Edited headline
TEXT_COL  = "edit"
# Mean funniness score
LABEL_COL = "meanGrade"

# Load and clean data
print("Loading training data...")
df = pd.read_csv(TRAIN_PATH)

print("Columns in train.csv:", df.columns.tolist())

# Drop rows with missing text or label
df = df.dropna(subset=[TEXT_COL, LABEL_COL])

X = df[TEXT_COL].astype(str).values
y = df[LABEL_COL].astype(float).values

print(f"Total samples: {len(X)}")

# Split into train and dev sets
X_train, X_dev, y_train, y_dev = train_test_split(
    X, y, test_size=0.1, random_state=42
)

print(f"Train size: {len(X_train)}, Dev size: {len(X_dev)}")

# Build TF-IDF + Linear Regression pipeline
model = make_pipeline(
    TfidfVectorizer(
        ngram_range=(1, 2),    
        max_features=50000,   
    ),
    LinearRegression()
)

# Train the model
print("Training TF-IDF + Linear Regression model...")
model.fit(X_train, y_train)

# Evaluate on the dev set
print("Evaluating on the dev set...")
y_pred = model.predict(X_dev)

mae = mean_absolute_error(y_dev, y_pred)
rmse = np.sqrt(mean_squared_error(y_dev, y_pred))

print("==============================")
print(f"Dev MAE  = {mae:.4f}")
print(f"Dev RMSE = {rmse:.4f}")
print("==============================")

# Save the model
joblib.dump(model, "linear_regression_tfidf.joblib")
print("Model saved to linear_regression_tfidf.joblib")

# Visualizations

# 9.1 Histogram of funniness scores in the full training set
plt.figure(figsize=(6, 4))
plt.hist(y, bins=20, edgecolor="black")
plt.xlabel("Funniness score (0â€“3)")
plt.ylabel("Count")
plt.title("Distribution of funniness scores (train set)")
plt.tight_layout()
plt.savefig("plot_funniness_distribution.png", dpi=300)
print("Saved: plot_funniness_distribution.png")

# 9.2 Scatter plot: true vs predicted scores on dev set
plt.figure(figsize=(6, 6))
plt.scatter(y_dev, y_pred, alpha=0.5)
# Reference line y = x
min_val = min(y_dev.min(), y_pred.min())
max_val = max(y_dev.max(), y_pred.max())
plt.plot([min_val, max_val], [min_val, max_val], linestyle="--")
plt.xlabel("True funniness score")
plt.ylabel("Predicted funniness score")
plt.title("True vs Predicted scores (dev set)")
plt.tight_layout()
plt.savefig("plot_true_vs_predicted.png", dpi=300)
print("Saved: plot_true_vs_predicted.png")

# 9.3 Histogram of prediction errors (residuals)
residuals = y_pred - y_dev

plt.figure(figsize=(6, 4))
plt.hist(residuals, bins=20, edgecolor="black")
plt.xlabel("Prediction error (predicted - true)")
plt.ylabel("Count")
plt.title("Distribution of prediction errors (dev set)")
plt.tight_layout()
plt.savefig("plot_residuals_distribution.png", dpi=300)
print("Saved: plot_residuals_distribution.png")
